# Nginx


## **웹 서버 - Web Server**

웹 서버는 브라우저와 같은 클라이언트로부터 HTTP 프로토콜을 통해 요청(Request)을 수신하고 HTML 문서 등의 **정적(Static) 데이터**를 응답(Response)으로서 전달하는 역할을 수행한다.

웹 서버는 크게 하드웨어적 측면과 소프트웨어적 측면으로 나누어지며, 각각에 대한 개념은 다음과 같다.

- **소프트웨어적 측면**
  - 사용자가 호스트된 파일에 접근하는 방식을 제어한다.
  - URL과 HTTP 포로토콜을 이해할 수 있는 소프트웨어이다.
  - 도메인 이름을 통해 웹 서버가 저장하고 있는 웹 사이트에 접근할 수 있으며, 최종 사용자에게 컨텐츠를 전달한다.
- **하드웨어적 측면**
  - 웹 어플리케이션을 구성하는 컴포넌트 파일(HTML, CSS, JS 파일 등)을 저장하는 컴퓨터이다.
  - 항상 인터넷에 연결되어, 웹에 연결된 다른 기기들(클라이언트)이 웹 서버의 데이터를 송/수신할 수 있도록 한다.
  - 최근은 물리적인 컴퓨터가 아닌, AWS와 같은 가상 클라우드 컴퓨터를 사용한다.

또한 웹 서버는 제공하는 데이터의 형태에 따라 **정적(Static) 웹 서버** 또는 **동적(Dynamic) 웹 서버**로 나뉘어진다. 

- **정적 웹 서버**
  - 요청(Request)이 도착하면 웹 서버에 저장되어 있는 파일을 그대로 반환다.
  - 정적 웹 서버에서 전달받은 웹 페이지는 **항상 동일한 형태**를 가진다.
- **동적 웹 서버**
  - 요청(Request)에 따라 웹 서버에서 실행되는 프로그램을 통해 데이터 또는 파일을 가공하여 반환한다.
  - 상황, 시간, 요청의 종류에 따라 전달받은 **웹 페이지의 형태가 달라진다.**
  - 데이터 가공을 전담하는 *WAS*를 별도로 구성하여 사용한다.

<br>

## **Nginx란?**

Nginx는 **동시접속 처리에 특화된 차세대 웹 서버 프로그램**이다. 전체적으로는 Apache가 여전히 시장 점유율 1위를 차지하고 있지만, AWS 환경에서 작동하는 어플리케이션으로 한정하면 전체의 44%가 Nginx를 사용하고 있다.

<br>

### **Nginx의 역할**

Nginx는 아래와 같은 두 가지 용도로 사용될 수 있으며, 현재 인턴으로 근무하고 있는 회사에서는 두 번째 역할인 **'응용프로그램 서버에 요청을 보내는 리버스 프록시 서버'** 용도로 사용되고 있다.

- 정적 데이터를 처리하는 HTTP 웹 서버로서의 역할
  - 이 경우, 앞에서 설명한 **정적 웹 서버의 역할을 수행**한다고 생각하면 된다.
- **응용프로그램 서버에 요청을 보내는 리버스 프록시 서버로서의 역할**

<br>

![Reverse Proxy Server](./ReverseProxy.png)

여기서 **리버스 프록시 서버**란, 위의 그림과 같이 클라이언트와 내부망에 존재하는 실제 어플리케이션 서버 사이에 존재하며 **클라이언트의 요청(Request)를 수신하고 해당 요청에 알맞는 어플리케이션 서버에서 데이터를 추출해 응답(Response)을 전달하는 서버**를 말한다.

위와 같은 리버스 프록시 서버를 사용하는 이유는 **보안 및 성능 개선**을 위해서이다. 

1. 클라이언트가 어플리케이션 서버(WAS 등)에 직접 접근하는 경우, 어플리케이션 서버는 일반적으로 데이터베이스에 연결되어 있으므로 어플리케이션 서버가 공격에 노출되면 데이터베이스까지 위험에 노출된다.
2. **로드 밸런싱(Load Balancing)** 적용을 통해 특정 서비스에 대한 요청(Request)이 몰리는 경우 단일 서버에 걸리는 부하를 분산할 수 있으며, 하나의 서버가 멈추더라도 서비스의 중단 없이 계속해서 서비스를 제공할 수 있다.

<br>

## **Nginx 사용해보기**

이미 회사에서 사용중인 AWS EC2 CentOS 인스턴스에 Nginx가 설치되어 있었기 때문에 별도의 설치는 필요하지 않았지만, 다음의 명령어를 이용해 리눅스 환경에서 Nginx를 설치할 수 있다.

```
sudo apt-get install nginx
```

위와 같은 방밥으로 Nginx를 설치하면 `/etc/nginx` 디렉토리에 설치되고, 회사에서도 이러한 방법을 사용했는지 동일한 디렉토리 위치에 Nginx가 설치되어 있다.

<br>

### **Nginx 설정**

`/etc/nginx/conf.d` 디렉토리에서 Nginx와 관련된 설정 파일을 확인하고 수정할 수 있다. 인터넷에서 참고한 게시물에 따라 설정 파일의 이름은 상이하지만, 회사에서는 Nginx 설치 시 기본 설정값을 담고있는 `default.conf` 파일을 그대로 수정하여 사용하고 있다.

```
sudo vi /etc/nginx/conf.d/default.conf
```

Nginx 설정 파일은 별도의 권한 설정을 하지 않았다면 기본적으로 *Root User*만 수정할 수 있기 때문에, 수정이 필요한 경우 `sudo` 명령어를 추가해 주어야 한다. Nginx 설정 파일은 아래의 예시에서 확인할 수 있는 일정한 형식을 따라 작성해야 한다.

```
upstream apiserver { 
  server localhost:7070;
  keepalive 10;
}

server {
  listen 80;

  server_name ino-on.devsmile.com www.ino-on.devsmile.com localhost 127.00.1;

  location /api {
    include /etc/nginx/proxy_params;
    proxy_pass http://apiserver;
  }
}
```

위의 예시는 Nginx 서버가 웹 서버 기본 포트인 80번 포트를 통해 도착하는 요청(Request)를 처리하도록 하며, `ino-on.devsmile.com`, `www.ino-on.devsmile.com`, `localhost`, 또는 `127.0.0.1`과 같은 도메인 이름을 이용해 서버에 접근할 수 있도록 한다.

또한  Nginx 서버에 도착하는 요청(Request) 중 `http://도메인-이름/api`와 같은 형태의 URL에  대해서, *Upstream*에 등록된 어플리케이션 서버가 작동하고 있는 위치인 `localhost:7070`에서 요청을 처리하도록 한다. 즉, 리버스 프록시의 역할을 수행하도록 설정한 것이다.

보다 자세한 Nginx 설정 방법은 [관련 내용이 굉장히 잘 정리되어 있는 블로그](https://developer88.tistory.com/299)에서 확인한다. 



